<!doctype html><html lang=ja prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://kakudokentaro.com/assets/fonts/Inter-SemiBold.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://kakudokentaro.com/assets/fonts/Inter-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://kakudokentaro.com/assets/css/null-2.4.css><link rel=stylesheet href=https://kakudokentaro.com/assets/css/common.css><link rel="shortcut icon" href=https://kakudokentaro.com/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=https://kakudokentaro.com/assets/css/document.css><link rel=stylesheet href=https://kakudokentaro.com/assets/css/single.css><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: false });
    await mermaid.run({
      querySelector: 'pre > code.language-mermaid', 
    });
  </script><title>研究室PCにCloudflare TunnelsでSSHする - Kakudo Kentaro</title><meta name=description content="学内ネットワークの研究室PCに、Cloudflare Tunnelsを利用してSSHした備忘録"><meta property="og:description" content="学内ネットワークの研究室PCに、Cloudflare Tunnelsを利用してSSHした備忘録"><meta property="og:title" content="研究室PCにCloudflare TunnelsでSSHする - Kakudo Kentaro"><meta property="og:type" content="website"><meta property="og:image" content="https://kakudokentaro.com/assets/icon.png"><meta property="og:url" content="https://kakudokentaro.com/blog/2023/05/17/lab-network-tunneling/"><meta property="og:site_name" content="Kakudo Kentaro"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@kakudo415"></head><body><header><div class=inner><h1><a href=https://kakudokentaro.com/>Kakudo Kentaro</a></h1><a href=https://kakudokentaro.com/blog/>Blog</a>
<a href=https://kakudokentaro.com/about/>About</a></div></header><main><div class=inner><h1>研究室PCにCloudflare TunnelsでSSHする</h1><time datetime=2023-05-17>2023-05-17 03:22</time><ul class=tags><li><a href=https://kakudokentaro.com/blog/tags/network/>Network</a></li><li><a href=https://kakudokentaro.com/blog/tags/cloudflare/>Cloudflare</a></li></ul><p>研究室に置いてある自分のPCに外部からSSHしたいとき、ありますよね？　私はあります。</p><p>しかし、セキュリティの都合か、学内ネットワークはたいてい外部に公開されていません。ファイアウォール以前にグローバルIPアドレスを持ってさえいないわけです。僕もその壁を前に途方に暮れていたんですが、ふと呟いてみたところ次のような返信をいただきました。</p><blockquote class=twitter-tweet data-conversation=none data-dnt=true data-theme=light><p lang=ja dir=ltr>cloudflare tunnelというまさしくなツール・サービスがあります<a href=https://t.co/vCBbaWdJgC>https://t.co/vCBbaWdJgC</a></p>&mdash; とりのマンボウ (@flat35hd99) <a href="https://twitter.com/flat35hd99/status/1656943423558148098?ref_src=twsrc%5Etfw">May 12, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>この返信がドンピシャで、完璧な解決案でした。ありがとうございます！
本記事では、設定手順と過程で学んだことを書き残しています。</p><h2 id=設定手順>設定手順</h2><p>以下の手順はあくまで備忘録です。次のような公式ドキュメントが存在しますので、詳しくはそちらをご覧ください。</p><ul><li>Tunnelの設定方法など: <a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/local/>Via the command line · Cloudflare Zero Trust docs</a></li><li>SSH接続を利用するときの設定方法など: <a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/use-cases/ssh/>SSH · Cloudflare Zero Trust docs</a></li></ul><p>ここでは仮に<code>example.com</code>をCloudflareのDNSで運用しているものとし、<code>mylab.example.com</code>にアクセスすることで研究室PCにSSH接続できるようにします。適宜お持ちのドメインに読み替えてください。</p><h3 id=cloudflaredのインストール><code>cloudflared</code>のインストール</h3><p>まずは接続元・接続先PC共に<code>cloudflared</code>をインストールし、ログインします。</p><p>OSごとのインストール方法は<a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/>Downloads · Cloudflare Zero Trust docs</a>をご覧いただくとして、macOSの場合は次のようになります。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>brew install cloudflared
</span></span></code></pre></div><p>インストールできたらログインします。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>cloudflared tunnel login
</span></span></code></pre></div><p>Webブラウザが立ち上がった方はそこから、CUI環境の方は表示されるURLをコピペしてCloudflareにログインします。どのドメイン下にTunnelを作るか聞かれるので、お好きなものを（この記事では<code>example.com</code>を）答えてください。</p><h3 id=研究室pc側tunnel作成>研究室PC側（Tunnel作成）</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>cloudflared tunnel create &lt;TUNNEL_NAME&gt;
</span></span></code></pre></div><p>トークンなどの認証情報が書かれた<code>~/.cloudflared/&lt;TUNNEL_ID>.json</code>ができます。</p><p>そうしたら、<code>~/.cloudflared/config.yml</code>に次のような設定を追加します。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:navy>url</span>:<span style=color:#bbb> </span>ssh://localhost:22<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>tunnel</span>:<span style=color:#bbb> </span>&lt;TUNNEL_ID&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>credentials-file</span>:<span style=color:#bbb> </span>&lt;&lt;TUNNEL_ID&gt;.json への絶対パス&gt;<span style=color:#bbb>
</span></span></span></code></pre></div><p>次に、DNSの設定をします。これでプライベートネットワーク外からは<code>mylab.example.com</code>にアクセスすることで研究室PCにアクセスすることができるようになります。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>cloudflared tunnel route dns &lt;TUNNEL_ID&gt; mylab.example.com
</span></span></code></pre></div><p>これでTunnelの設定は完了です。<code>cloudflared</code>を再起動して設定を適用します。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>cloudflared service restart
</span></span></code></pre></div><p>公式ドキュメントによるとこれで再起動されるはずですが、自分の環境では<code>Register tunnel error from server side error="Unauthorized: Failed to get tunnel"</code>というエラーが出て上手くいかなかったため次のように<code>service</code>を再インストールしました。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>sudo cloudflared service uninstall
</span></span><span style=display:flex><span>sudo cloudflared --config &lt;config.jsonへの絶対パス&gt; service install
</span></span></code></pre></div><p>再起動、ないし再インストールを行うことで、研究室PCとCloudflareがTunnelで接続されます。</p><h3 id=手元のpcssh設定>手元のPC（SSH設定）</h3><p><code>~/.ssh/config</code>を次のように編集して、Cloudflare経由でSSH接続するように設定します。</p><pre tabindex=0><code>Host &lt;NICKNAME&gt;
    Hostname mylab.example.com
    User &lt;USERNAME&gt;
    ProxyCommand &lt;cloudflaredへの絶対パス&gt; access ssh --hostname %h
</code></pre><h3 id=接続方法>接続方法</h3><p>設定名だけで接続できるのを初めて知りました。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>ssh &lt;NICKNAME&gt;
</span></span></code></pre></div><p>これでプライベートネットワーク内の研究室PCに外部からSSH接続できます！めでたい！便利！</p><h2 id=cloudflare-tunnelの仕組み>Cloudflare Tunnelの仕組み</h2><p>TODO: そのうち勉強して書く</p><h2 id=ssh-proxycommandとは>SSH ProxyCommandとは</h2><p>TEACHME: 結局どういう風に動作しているのか全然わからん。
そもそも、このProxyCommandは手元で実行されているという理解でよい？</p><h2 id=終わりに>終わりに</h2><p>Cloudflareはどうやって儲けてるんですか？</p><h2 id=参考にしたもの>参考にしたもの</h2><ol><li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/>Downloads · Cloudflare Zero Trust docs</a></li><li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/local/>Via the command line · Cloudflare Zero Trust docs</a></li><li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/use-cases/ssh/>SSH · Cloudflare Zero Trust docs</a></li><li><a href=https://serverfault.com/questions/544545/how-does-ssh-proxycommand-actually-work>proxy - How does ssh ProxyCommand actually work? - Server Fault</a></li></ol><section class=share><div>Share on</div><a href="https://twitter.com/intent/tweet?text=%e7%a0%94%e7%a9%b6%e5%ae%a4PC%e3%81%abCloudflare%20Tunnels%e3%81%a7SSH%e3%81%99%e3%82%8b - Kakudo%20Kentaro&url=https%3a%2f%2fkakudokentaro.com%2fblog%2f2023%2f05%2f17%2flab-network-tunneling%2f" rel="nofollow noopener noreferrer" target=_blank>Twitter</a></section></div></main></body></html>