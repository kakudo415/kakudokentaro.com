<!doctype html><html lang=ja prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://kakudokentaro.com/assets/fonts/Inter-SemiBold.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://kakudokentaro.com/assets/fonts/Inter-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://kakudokentaro.com/assets/css/null-2.4.css><link rel=stylesheet href=https://kakudokentaro.com/assets/css/common.css><link rel="shortcut icon" href=https://kakudokentaro.com/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=https://kakudokentaro.com/assets/css/document.css><link rel=stylesheet href=https://kakudokentaro.com/assets/css/single.css><title>Rustでもグローバル変数 - Kakudo Kentaro</title><meta name=description content="Version 1.63から使えるグローバル変数について"><meta property="og:description" content="Version 1.63から使えるグローバル変数について"><meta property="og:title" content="Rustでもグローバル変数 - Kakudo Kentaro"><meta property="og:type" content="website"><meta property="og:image" content="https://kakudokentaro.com/assets/icon.png"><meta property="og:url" content="https://kakudokentaro.com/blog/2022/12/21/global-variable-in-rust/"><meta property="og:site_name" content="Kakudo Kentaro"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@kakudo415"></head><body><header><div class=inner><h1><a href=https://kakudokentaro.com/>Kakudo Kentaro</a></h1><a href=https://kakudokentaro.com/blog/>Blog</a>
<a href=https://kakudokentaro.com/about/>About</a></div></header><main><div class=inner><h1>Rustでもグローバル変数</h1><time datetime=2022-12-21>2022-12-21 00:00</time><ul class=tags><li><a href=https://kakudokentaro.com/blog/tags/rust/>Rust</a></li></ul><p>これは、<a href=https://adventar.org/calendars/7447>RICORA Advent Calendar 2022</a> の <strong>21日目</strong> の記事です。</p><p>昨日は、<strong>remeta</strong>さんの『<a href=https://speakerdeck.com/000meta/goodbye-santa>またね、サンタさん / Goodbye, Santa</a>』でした。</p><p>今日は、Rust 1.63から使えるようになった、<strong>const</strong> な <code>Mutex::new()</code> についてです。</p><blockquote class=twitter-tweet data-conversation=none><p lang=en dir=ltr>Another thing I'm very excited about, is that Mutex, RwLock and Condvar now all have a _const_ new function.<br><br>This means you can now have a static Mutex without having to use lazy_static or once_cell. ✨<br><br>3/16 <a href=https://t.co/M9X71vmZ0j>pic.twitter.com/M9X71vmZ0j</a></p>&mdash; Mara Bos (@m_ou_se) <a href="https://twitter.com/m_ou_se/status/1557743601761013762?ref_src=twsrc%5Etfw">August 11, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=これまでのグローバル変数>これまでのグローバル変数</h2><p>1.62以前のRustでは、<code>lazy_static</code> や <code>once_cell</code> を利用して可変なグローバル変数を作っていました。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>once_cell::sync::Lazy;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>static</span><span style=color:#bbb> </span>GLOBAL: <span style=color:#458;font-weight:700>Lazy</span><span style=color:#000;font-weight:700>&lt;</span>Mutex<span style=color:#000;font-weight:700>&lt;</span>Global<span style=color:#000;font-weight:700>&gt;&gt;</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>Lazy::new(<span style=color:#000;font-weight:700>||</span><span style=color:#bbb> </span>Mutex::new({<span style=color:#bbb> </span><span style=color:#000;font-weight:700>..</span>.<span style=color:#bbb> </span>}));<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=これからのグローバル変数>これからのグローバル変数</h2><p>新しい書き方について知る前に、まずはRustの<code>const</code>文脈について知る必要があります。</p><h3 id=const-文脈とは><code>const</code> 文脈とは</h3><p>Rustの式・変数・定数には、コンパイル時に値が決定されなくてはならないものがいくつかあります。
具体的には以下に示した通りで、グローバル変数を実現するために必要な static 変数も該当します。</p><ul><li>配列の長さ部分 <code>[型; 長さ]</code></li><li>配列の繰り返し回数部分 <code>[要素; 繰り返し回数]</code></li><li>以下のものを初期化する式<ul><li>定数</li><li>static 変数</li><li>enum 型の定数部分(descriminant)</li></ul></li><li>ジェネリック定数変数 <code>fn f&lt;const N: isize>()</code>の<code>N</code>に渡されるもの</li></ul><p>詳しくは、<a href=https://doc.rust-lang.org/reference/const_eval.html#const-context>Constant Evaluation - The Rust Reference</a></p><h3 id=const-fn-について><code>const fn</code> について</h3><p>そのため、実行時に評価される通常の関数はグローバル変数の初期化には使えません。</p><p>そこで登場するのが<code>const</code>文脈で呼び出せる<code>const fn</code>です。
一定の制限をクリアすることでコンパイル時に実行してくれるため、<code>const</code>文脈でも使えるわけです。
コンパイル時に実行して困ることはあまりないため、標準ライブラリの関数たちも順次<code>const fn</code>に書き換えが進んでいるようです。</p><h3 id=新しい-mutexnew>新しい <code>Mutex::new()</code></h3><p>そして、Rust 1.63から遂に<code>Mutex::new()</code>も<code>const fn</code>となりました！</p><p>これによってstatic変数の初期化が可能になったため、以下のようにグローバル変数を簡単に、かつ安全に書くことができるようになったわけです。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#000;font-weight:700>static</span><span style=color:#bbb> </span>GLOBAL: <span style=color:#458;font-weight:700>Mutex</span><span style=color:#000;font-weight:700>&lt;</span>Global<span style=color:#000;font-weight:700>&gt;</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>Mutex::new(<span style=color:#bbb> </span><span style=color:#000;font-weight:700>..</span>.<span style=color:#bbb> </span>);<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=終わりに>終わりに</h2><p>一瞬で3年生も終わりとなり、もうOBと呼ばれる学年になったことに戦慄しています。
学年間の垣根が非常に低いRICORAですが、かと言ってうざったい先輩にならないように気をつけていきます。</p><p>明日は<strong>unagi_dog</strong>さんの『OAuth2.0まとめ』が予定されていますのでお楽しみに！</p><section class=share><div>Share on</div><a href="https://twitter.com/intent/tweet?text=Rust%e3%81%a7%e3%82%82%e3%82%b0%e3%83%ad%e3%83%bc%e3%83%90%e3%83%ab%e5%a4%89%e6%95%b0 - Kakudo%20Kentaro&url=https%3a%2f%2fkakudokentaro.com%2fblog%2f2022%2f12%2f21%2fglobal-variable-in-rust%2f" rel="nofollow noopener noreferrer" target=_blank>Twitter</a></section></div></main></body></html>